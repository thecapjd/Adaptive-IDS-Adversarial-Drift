# 03_vulnerability_assessment.py
# Description: Evaluates the performance collapse of pre-trained models.
# Input: 'adversarial_dataset.csv' (English Schema)

import pandas as pd
import numpy as np
import joblib
import tensorflow as tf
from sklearn.metrics import classification_report

def assess_vulnerability():
    print("--- [Phase 3] Vulnerability Assessment ---")
    
    # 1. Load Resources
    try:
        rf_model = joblib.load('rf_model.joblib')
        cnn_model = tf.keras.models.load_model('cnn_lstm_model.keras')
        scaler = joblib.load('scaler.joblib')
        print("Status: Models and Scaler loaded.")
    except Exception as e:
        print(f"Error loading models: {e}")
        return

    # 2. Load Adversarial Data
    try:
        df_adv = pd.read_csv('adversarial_dataset.csv')
        print(f"Status: Adversarial dataset loaded ({len(df_adv)} samples).")
    except FileNotFoundError:
        print("Error: 'adversarial_dataset.csv' not found. RUN PHASE 2 FIRST.")
        return

    # 3. Prepare Data
    # Drop Metadata (English Names)
    drop_cols = ['label', 'ip_src', 'ip_dst', 'timestamp', 'flow_id']
    X_raw = df_adv.drop(columns=[c for c in drop_cols if c in df_adv.columns], errors='ignore')
    y_true = df_adv['label']
    
    # CRITICAL: Reorder columns to match Training Phase
    if hasattr(scaler, 'feature_names_in_'):
        try:
            X_raw = X_raw[scaler.feature_names_in_]
        except KeyError as e:
            print(f"\nCRITICAL ERROR: CSV columns don't match Model columns.")
            print(f"Model expects: {list(scaler.feature_names_in_)[:5]}...")
            print(f"CSV has:       {list(X_raw.columns)[:5]}...")
            return
            
    X_raw = X_raw.fillna(0)

    # 4. Evaluate RF
    print("\n--- Random Forest Evaluation ---")
    # Interpretation: If Recall for class 1 is ~0.00, the attack was successful
    y_pred_rf = rf_model.predict(X_raw)
    print(classification_report(y_true, y_pred_rf, digits=4))

    # 5. Evaluate CNN-LSTM
    print("\n--- CNN-LSTM Evaluation ---")
    X_scaled = scaler.transform(X_raw)
    X_reshaped = X_scaled.reshape(X_scaled.shape[0], 1, X_scaled.shape[1])
    
    y_prob = cnn_model.predict(X_reshaped, verbose=0)
    y_pred_cnn = (y_prob > 0.5).astype(int)
    print(classification_report(y_true, y_pred_cnn, digits=4))

if __name__ == "__main__":
    assess_vulnerability()